apiVersion: serving.kserve.io/v1beta1
kind: InferenceService
metadata:
  name: {{ spec.name }}
  namespace: {{ spec.namespace }}
  labels:
    app.kubernetes.io/name: {{ spec.name }}
    app.kubernetes.io/part-of: ai-navigator
    app.kubernetes.io/managed-by: ai-navigator
{% for key, value in spec.labels.items() %}
    {{ key }}: {{ value }}
{% endfor %}
  annotations:
    serving.kserve.io/autoscalerClass: hpa
    serving.kserve.io/deploymentMode: RawDeployment
{% for key, value in spec.annotations.items() %}
    {{ key }}: {{ value }}
{% endfor %}
spec:
  predictor:
    minReplicas: {{ spec.min_replicas }}
    maxReplicas: {{ spec.max_replicas }}
    scaleTarget: {{ spec.scale_target }}
    scaleMetric: {{ spec.scale_metric }}
    timeout: {{ spec.timeout_seconds }}
    model:
      modelFormat:
        name: {{ spec.model_format }}
{% if spec.storage_uri %}
      storageUri: {{ spec.storage_uri }}
{% endif %}
{% if spec.runtime %}
      runtime: {{ spec.runtime.runtime_name }}
{% if spec.runtime.runtime_name == 'vllm' %}
      args:
        - --tensor-parallel-size={{ spec.runtime.tensor_parallel_size }}
        - --gpu-memory-utilization={{ spec.runtime.gpu_memory_utilization }}
        - --dtype={{ spec.runtime.dtype }}
{% if spec.runtime.max_model_len %}
        - --max-model-len={{ spec.runtime.max_model_len }}
{% endif %}
{% if spec.runtime.enforce_eager %}
        - --enforce-eager
{% endif %}
{% for arg in spec.runtime.extra_args %}
        - {{ arg }}
{% endfor %}
{% endif %}
{% if spec.runtime.env_vars %}
      env:
{% for key, value in spec.runtime.env_vars.items() %}
        - name: {{ key }}
          value: "{{ value }}"
{% endfor %}
{% endif %}
{% endif %}
      resources:
        requests:
          cpu: "{{ spec.cpu }}"
          memory: {{ spec.memory }}
{% if spec.gpu_count > 0 %}
          nvidia.com/gpu: "{{ spec.gpu_count }}"
{% endif %}
        limits:
          cpu: "{{ spec.cpu | int * 2 }}"
          memory: {{ spec.memory }}
{% if spec.gpu_count > 0 %}
          nvidia.com/gpu: "{{ spec.gpu_count }}"
{% endif %}
{% if spec.gpu_type %}
    nodeSelector:
      nvidia.com/gpu.product: {{ spec.gpu_type }}
{% endif %}
